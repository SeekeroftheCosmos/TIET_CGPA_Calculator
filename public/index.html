<!DOCTYPE html>
<html>
<head>
  <title>CGPA & SGPA Calculator</title>
  <!-- Firebase SDKs using ES Modules from the official CDN -->
  <script type="module">
    // Import the functions you need from the Firebase SDKs you need.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-analytics.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyAfpUT9nAUfW5laVmK7HWkhWUeLaKp6og4",
      authDomain: "tiet-cgpa-calculator-6049a.firebaseapp.com",
      projectId: "tiet-cgpa-calculator-6049a",
      storageBucket: "tiet-cgpa-calculator-6049a.firebasestorage.app",
      messagingSenderId: "922296897245",
      appId: "1:922296897245:web:cda1dfbdb7af4087d65534",
      measurementId: "G-Y77XZRYJHN"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getFirestore(app);

    // Mapping of grades to grade points
    const gradePoints = { "A": 10, "A-": 9, "B": 8, "B-": 7, "C": 6, "E": 2, "I": 0 };

    // Function to add a course to Firestore
    async function addCourse() {
      console.log("addCourse() called");
      const name = document.getElementById("courseName").value;
      const code = document.getElementById("courseCode").value;
      const credit = parseFloat(document.getElementById("courseCredit").value);
      const semester = document.getElementById("semesterCode").value;
      const grade = document.getElementById("grade").value;

      if (!name || !code || isNaN(credit) || !semester || !grade) {
        alert("Please enter all fields!");
        return;
      }

      try {
        await addDoc(collection(db, "courses"), { name, code, credit, semester, grade });
        console.log("Course added successfully");
        // Clear form inputs after adding
        document.getElementById("courseName").value = "";
        document.getElementById("courseCode").value = "";
        document.getElementById("courseCredit").value = "";
        document.getElementById("semesterCode").value = "";
        document.getElementById("grade").selectedIndex = 0;
        loadCourses();
      } catch (error) {
        console.error("Error adding course:", error);
      }
    }

    // Function to load courses and update CGPA/SGPA displays
    async function loadCourses() {
      try {
        const snapshot = await getDocs(collection(db, "courses"));
        let courses = [];
        let bestAttempts = {};  // For overall CGPA: best attempt per course code
        let semesterData = {};  // For SGPA: accumulate credits and points per semester

        snapshot.forEach(docSnap => {
          let course = docSnap.data();
          course.id = docSnap.id;
          courses.push(course);

          // For SGPA: accumulate if grade is not "I"
          if (!semesterData[course.semester]) {
            semesterData[course.semester] = { credits: 0, points: 0 };
          }
          if (course.grade !== "I") {
            let gp = gradePoints[course.grade] || 0;
            semesterData[course.semester].credits += course.credit;
            semesterData[course.semester].points += gp * course.credit;
          }

          // For CGPA: only store best attempt (exclude grade "I")
          if (course.grade !== "I") {
            let gp = gradePoints[course.grade] || 0;
            if (!bestAttempts[course.code] || gp > gradePoints[bestAttempts[course.code].grade]) {
              bestAttempts[course.code] = course;
            }
          }
        });

        // Calculate overall CGPA using best attempts
        let totalCredits = 0, totalPoints = 0;
        for (let code in bestAttempts) {
          let course = bestAttempts[code];
          totalCredits += course.credit;
          totalPoints += gradePoints[course.grade] * course.credit;
        }
        const cgpa = totalCredits ? (totalPoints / totalCredits).toFixed(2) : "N/A";
        document.getElementById("cgpa").innerText = cgpa;

        // Build the course list table
        const tableContent = courses.map(c => `
          <tr>
            <td>${c.name}</td>
            <td>${c.code}</td>
            <td>${c.credit}</td>
            <td>${c.semester}</td>
            <td>${c.grade}</td>
            <td><button onclick="deleteCourse('${c.id}')">Delete</button></td>
          </tr>
        `).join("");
        document.getElementById("courseTable").innerHTML = tableContent;

        // Build SGPA display for each semester
        const sgpaContent = Object.keys(semesterData).map(sem => {
          const data = semesterData[sem];
          const sgpa = data.credits ? (data.points / data.credits).toFixed(2) : "N/A";
          return `<p>Semester ${sem}: SGPA = ${sgpa}</p>`;
        }).join("");
        document.getElementById("sgpa").innerHTML = sgpaContent;

      } catch (error) {
        console.error("Error loading courses:", error);
      }
    }

    // Function to delete a course from Firestore
    async function deleteCourse(id) {
      try {
        await deleteDoc(doc(db, "courses", id));
        loadCourses();
      } catch (error) {
        console.error("Error deleting course:", error);
      }
    }

    // Load courses when the window loads
    window.onload = loadCourses;
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; }
    form { margin-bottom: 20px; }
    label { display: inline-block; width: 150px; }
    input, select { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>CGPA & SGPA Calculator</h2>
  <!-- The form uses event.preventDefault() to prevent page refresh -->
  <form onsubmit="event.preventDefault(); addCourse();">
    <label for="courseName">Course Name:</label>
    <input type="text" id="courseName" required><br>
    
    <label for="courseCode">Course Code:</label>
    <input type="text" id="courseCode" required><br>
    
    <label for="courseCredit">Course Credit:</label>
    <input type="number" id="courseCredit" step="0.5" required><br>
    
    <label for="semesterCode">Semester Code:</label>
    <input type="text" id="semesterCode" required><br>
    
    <label for="grade">Grade:</label>
    <select id="grade">
      <option>A</option>
      <option>A-</option>
      <option>B</option>
      <option>B-</option>
      <option>C</option>
      <option>E</option>
      <option>I</option>
    </select><br>
    
    <button type="submit">Add Course</button>
  </form>
  
  <h3>Overall CGPA: <span id="cgpa">N/A</span></h3>
  <h3>SGPA by Semester:</h3>
  <div id="sgpa"></div>
  
  <h3>Course List</h3>
  <table>
    <tr>
      <th>Course Name</th>
      <th>Course Code</th>
      <th>Credit</th>
      <th>Semester</th>
      <th>Grade</th>
      <th>Action</th>
    </tr>
    <tbody id="courseTable"></tbody>
  </table>
</body>
</html>
